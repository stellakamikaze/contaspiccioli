{% extends "base.html" %}

{% block title %}Dashboard v2 - Contaspiccioli{% endblock %}

{% block content %}
<div class="space-y-8">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-display font-bold">Cash Flow Planner</h1>
            <p class="text-muted-foreground">{{ month_name }} {{ year }} - I 4 Pilastri</p>
        </div>
        <div class="flex items-center gap-3">
            <span class="text-sm text-muted-foreground">Reddito mensile:</span>
            <span class="text-xl font-bold text-accent">{{ monthly_income|currency }} &euro;</span>
        </div>
    </div>

    <!-- 4 Pillars Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        {% for pillar in pillars %}
        <div class="card p-5 {% if pillar.is_funded %}card-highlight{% endif %}">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-2">
                    <span class="text-2xl">
                        {% if pillar.number == 1 %}1&#xFE0F;&#x20E3;{% elif pillar.number == 2 %}2&#xFE0F;&#x20E3;{% elif pillar.number == 3 %}3&#xFE0F;&#x20E3;{% else %}4&#xFE0F;&#x20E3;{% endif %}
                    </span>
                    <h3 class="font-semibold text-sm">{{ pillar.display_name }}</h3>
                </div>
                {% if pillar.is_funded %}
                <span class="text-xs px-2 py-1 bg-accent/20 text-accent rounded-full">Completo</span>
                {% endif %}
            </div>

            <div class="space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-muted-foreground">Saldo</span>
                    <span class="font-medium">{{ pillar.current_balance|currency }} &euro;</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-muted-foreground">Target</span>
                    <span class="font-medium">{{ pillar.target_balance|currency }} &euro;</span>
                </div>

                <div class="progress-bar h-2 mt-3">
                    <div class="progress-fill {% if pillar.completion_percentage >= 100 %}bg-accent{% elif pillar.completion_percentage >= 50 %}bg-amber-500{% else %}bg-red-400{% endif %}"
                         style="width: {{ [pillar.completion_percentage, 100]|min }}%"></div>
                </div>
                <div class="flex justify-between text-xs text-muted-foreground">
                    <span>{{ pillar.completion_percentage|round|int }}%</span>
                    {% if pillar.shortfall > 0 %}
                    <span class="text-red-400">-{{ pillar.shortfall|currency }} &euro;</span>
                    {% elif pillar.surplus > 0 %}
                    <span class="text-accent">+{{ pillar.surplus|currency }} &euro;</span>
                    {% endif %}
                </div>
            </div>

            <div class="mt-3 pt-3 border-t border-white/5 text-xs text-muted-foreground">
                <p>{{ pillar.instrument }}</p>
                <p class="text-accent/70">{{ pillar.account_name }}</p>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Summary Bar -->
    <div class="card p-4">
        <div class="flex flex-wrap items-center justify-between gap-4">
            <div class="flex items-center gap-6">
                <div>
                    <p class="text-xs text-muted-foreground">Totale Allocato</p>
                    <p class="text-xl font-bold">{{ total_balance|currency }} &euro;</p>
                </div>
                <div>
                    <p class="text-xs text-muted-foreground">Target Totale</p>
                    <p class="text-xl font-bold text-muted-foreground">{{ total_target|currency }} &euro;</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="progress-bar w-32 h-3">
                    <div class="progress-fill bg-accent" style="width: {{ [overall_completion, 100]|min }}%"></div>
                </div>
                <span class="text-lg font-bold">{{ overall_completion|round|int }}%</span>
            </div>
        </div>
    </div>

    <!-- Cash Flow Projection -->
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Proiezione Liquidit&agrave; (6 mesi)</h2>

        <div class="overflow-x-auto">
            <table class="w-full">
                <thead>
                    <tr class="text-xs text-muted-foreground uppercase tracking-wider">
                        <th class="text-left py-3 px-2">Mese</th>
                        <th class="text-right py-3 px-2">Apertura</th>
                        <th class="text-right py-3 px-2">Entrate</th>
                        <th class="text-right py-3 px-2">Uscite</th>
                        <th class="text-right py-3 px-2">Chiusura</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-white/5">
                    {% for p in projections %}
                    <tr class="hover:bg-white/[0.02] transition-colors">
                        <td class="py-3 px-2 font-medium">{{ p.month_name }} {{ p.year }}</td>
                        <td class="py-3 px-2 text-right text-muted-foreground">{{ p.opening|currency }} &euro;</td>
                        <td class="py-3 px-2 text-right text-accent">+{{ p.income|currency }} &euro;</td>
                        <td class="py-3 px-2 text-right text-red-400">-{{ p.costs|currency }} &euro;</td>
                        <td class="py-3 px-2 text-right font-bold {% if p.closing < 0 %}text-red-400{% endif %}">{{ p.closing|currency }} &euro;</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Tax Deadlines -->
    {% if deadlines %}
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Prossime Scadenze Fiscali</h2>

        <div class="space-y-3">
            {% for d in deadlines %}
            <div class="flex items-center justify-between p-3 bg-muted/50 rounded-lg {% if d.days_remaining <= 7 %}border border-red-500/30{% endif %}">
                <div class="flex items-center gap-4">
                    <div class="text-center w-14">
                        <p class="text-2xl font-bold {% if d.days_remaining <= 7 %}text-red-400{% elif d.days_remaining <= 30 %}text-amber-400{% else %}text-muted-foreground{% endif %}">
                            {{ d.days_remaining }}
                        </p>
                        <p class="text-xs text-muted-foreground">giorni</p>
                    </div>
                    <div>
                        <p class="font-medium">{{ d.name }}</p>
                        <p class="text-sm text-muted-foreground">{{ d.due_date.strftime('%d/%m/%Y') }}</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-lg font-bold">{{ d.remaining|currency }} &euro;</p>
                    {% if d.amount_paid > 0 %}
                    <p class="text-xs text-accent">{{ d.amount_paid|currency }} &euro; pagati</p>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Quick Actions -->
    <div class="flex flex-wrap gap-3 justify-center">
        <a href="/api/v2/pillars/allocation-suggestions?amount=1000"
           class="btn-secondary px-4 py-2 text-sm rounded-lg">
            Suggerisci Allocazione
        </a>
        <a href="/" class="btn-secondary px-4 py-2 text-sm rounded-lg">
            Dashboard v1
        </a>
    </div>
</div>
{% endblock %}
