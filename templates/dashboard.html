{% extends "base.html" %}

{% block title %}Dashboard - Contaspiccioli{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-display font-bold">{{ month_name }} {{ year }}</h1>
            <p class="text-muted-foreground">Gestione flusso di cassa</p>
        </div>
        <a href="/setup?step=1" class="btn-secondary px-4 py-2 text-sm">
            Modifica configurazione
        </a>
    </div>

    <!-- INTROITI SECTION -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold">Introiti {{ month_name }}</h2>
            <button onclick="document.getElementById('income-modal').classList.remove('hidden')"
                    class="btn-primary px-4 py-2 text-sm">
                + Aggiungi
            </button>
        </div>

        <div class="space-y-3">
            {% if monthly_incomes %}
                {% for income in monthly_incomes %}
                <div class="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üí∞</span>
                        <div>
                            <p class="font-medium">{{ income.source }}</p>
                            <p class="text-xs text-muted-foreground">
                                {% if income.is_received %}
                                    ‚úì Ricevuto {{ income.received_date|date if income.received_date else '' }}
                                {% else %}
                                    ‚óã Previsto
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <span class="text-xl font-bold text-accent">{{ income.amount|currency }} ‚Ç¨</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üí∞</span>
                        <div>
                            <p class="font-medium">Entrata prevista</p>
                            <p class="text-xs text-muted-foreground">Basata sulla configurazione</p>
                        </div>
                    </div>
                    <span class="text-xl font-bold text-accent">{{ profile.monthly_income|currency }} ‚Ç¨</span>
                </div>
            {% endif %}
        </div>

        <div class="mt-4 pt-4 border-t border-border flex justify-between items-center">
            <div>
                <p class="text-sm text-muted-foreground">Totale mese</p>
                <p class="text-2xl font-bold">{{ total_income|currency }} ‚Ç¨</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-muted-foreground">Proiezione anno</p>
                <p class="text-xl font-medium text-muted-foreground">{{ (total_income * 12)|currency }} ‚Ç¨</p>
            </div>
        </div>
    </div>

    <!-- ALLOCAZIONE AUTOMATICA -->
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Allocazione da {{ total_income|currency }} ‚Ç¨</h2>

        <div class="space-y-4">
            <!-- Spese Fisse -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>1Ô∏è‚É£ Spese fisse</span>
                    <span>{{ allocations.fixed|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ ((allocations.fixed / total_income) * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-blue-500" style="width: {{ [((summary.fixed_spent / allocations.fixed) * 100), 100]|min }}%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">Speso: {{ summary.fixed_spent|currency }} ‚Ç¨ ({{ ((summary.fixed_spent / allocations.fixed) * 100)|round|int }}%)</p>
            </div>

            <!-- Spese Variabili -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>2Ô∏è‚É£ Spese variabili</span>
                    <span>{{ allocations.variable|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ ((allocations.variable / total_income) * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-purple-500" style="width: {{ [((summary.variable_spent / allocations.variable) * 100), 100]|min }}%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">Speso: {{ summary.variable_spent|currency }} ‚Ç¨ ({{ ((summary.variable_spent / allocations.variable) * 100)|round|int }}%)</p>
            </div>

            <!-- Accantonamento Tasse -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>3Ô∏è‚É£ Accantonamento tasse</span>
                    <span>{{ allocations.tax|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ (profile.tax_percentage * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-amber-500" style="width: 100%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">‚Üí XEON Tasse</p>
            </div>

            <!-- Investimenti -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>4Ô∏è‚É£ Investimenti</span>
                    <span>{{ allocations.investment|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ (profile.investment_percentage * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-accent" style="width: 100%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">‚Üí ETF</p>
            </div>
        </div>
    </div>

    <!-- 4 PILASTRI -->
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Saldi 4 Pilastri</h2>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Conto Corrente -->
            <div class="p-4 bg-muted rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <span>üè¶</span>
                    <span class="text-sm font-medium">Conto Corrente</span>
                </div>
                <p class="text-xl font-bold">{{ profile.current_balance|currency }} ‚Ç¨</p>
                <p class="text-xs text-muted-foreground">Spese quotidiane</p>
            </div>

            {% for pillar in pillars %}
            <div class="p-4 bg-muted rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <span>{% if pillar.name == 'emergenza' %}üõ°Ô∏è{% elif pillar.name == 'tasse' %}üìã{% else %}üìà{% endif %}</span>
                    <span class="text-sm font-medium">{{ pillar.display_name|replace(' (2)', '')|replace(' (3)', '')|replace(' (4)', '') }}</span>
                </div>
                <p class="text-xl font-bold {% if pillar.name == 'emergenza' and pillar.actual >= pillar.target %}text-accent{% endif %}">
                    {{ pillar.actual|currency }} ‚Ç¨
                </p>
                {% if pillar.name == 'emergenza' %}
                    {% if pillar.actual >= pillar.target %}
                    <p class="text-xs text-accent">‚úì Target raggiunto</p>
                    {% else %}
                    <p class="text-xs text-muted-foreground">Target: {{ pillar.target|currency }} ‚Ç¨</p>
                    {% endif %}
                {% elif pillar.name == 'tasse' %}
                    <p class="text-xs text-muted-foreground">+{{ (profile.monthly_income * profile.tax_percentage)|currency }} ‚Ç¨/mese</p>
                {% else %}
                    <p class="text-xs text-muted-foreground">+{{ (profile.monthly_income * profile.investment_percentage)|currency }} ‚Ç¨/mese</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- SCADENZE FISCALI -->
    {% if deadlines %}
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Prossime Scadenze Fiscali</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for deadline in deadlines %}
            <div class="p-4 bg-muted rounded-lg {% if deadline.urgent %}border-2 border-red-500{% endif %}">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium">{{ deadline.name }}</p>
                        <p class="text-sm text-muted-foreground">{{ deadline.due_date|date }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg">{{ deadline.residuo|currency }} ‚Ç¨</p>
                        <p class="text-sm {% if deadline.urgent %}text-red-500{% else %}text-muted-foreground{% endif %}">
                            {% if deadline.urgent %}‚ö†Ô∏è {% endif %}{{ deadline.days_remaining }} giorni
                        </p>
                    </div>
                </div>
                {% set tax_pillar = pillars|selectattr('name', 'equalto', 'tasse')|first %}
                {% if tax_pillar %}
                <div class="mt-3 pt-3 border-t border-border">
                    <div class="flex justify-between text-sm">
                        <span class="text-muted-foreground">Copertura XEON Tasse:</span>
                        <span class="{% if tax_pillar.actual >= deadline.residuo %}text-accent{% else %}text-amber-400{% endif %}">
                            {{ ((tax_pillar.actual / deadline.residuo) * 100)|round|int }}%
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Income Modal -->
<div id="income-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="card p-6 w-full max-w-md mx-4">
        <div class="flex justify-between items-center mb-6">
            <h2 class="text-xl font-display font-semibold">Aggiungi Entrata</h2>
            <button onclick="document.getElementById('income-modal').classList.add('hidden')"
                    class="text-muted-foreground hover:text-foreground text-2xl transition-colors">&times;</button>
        </div>

        <form action="/income/add" method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">Fonte</label>
                <input type="text" name="source" required
                       class="input w-full px-4 py-3"
                       placeholder="Es: Ufficio Furore, Cliente X">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Importo</label>
                <input type="number" name="amount" step="0.01" required
                       class="input w-full px-4 py-3"
                       placeholder="3500">
            </div>

            <div class="flex items-center gap-3">
                <input type="checkbox" name="is_received" id="is_received" value="true"
                       class="w-5 h-5 rounded bg-muted border-border accent-accent">
                <label for="is_received" class="text-sm">Gi√† ricevuto</label>
            </div>

            <div class="flex gap-3 justify-end pt-4">
                <button type="button"
                        onclick="document.getElementById('income-modal').classList.add('hidden')"
                        class="btn-secondary px-5 py-2.5">
                    Annulla
                </button>
                <button type="submit"
                        class="btn-primary px-5 py-2.5">
                    Aggiungi
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
