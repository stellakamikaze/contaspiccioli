{% extends "base.html" %}

{% block title %}Dashboard - Contaspiccioli{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex items-center justify-between">
        <div>
            <h1 class="text-3xl font-display font-bold">{{ month_name }} {{ year }}</h1>
            <p class="text-muted-foreground">Gestione flusso di cassa</p>
        </div>
        <a href="/setup?step=1" class="btn-secondary px-4 py-2 text-sm">
            Modifica configurazione
        </a>
    </div>

    <!-- INTROITI SECTION -->
    <div class="card p-6">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h2 class="text-xl font-semibold">Introiti {{ month_name }}</h2>
                <p class="text-xs text-muted-foreground">Aggiungi entrate extra solo per questo mese</p>
            </div>
            <button onclick="document.getElementById('income-modal').classList.remove('hidden')"
                    class="btn-primary px-4 py-2 text-sm">
                + Aggiungi
            </button>
        </div>

        <div class="space-y-3">
            {% if monthly_incomes %}
                {% for income in monthly_incomes %}
                <div class="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üí∞</span>
                        <div>
                            <p class="font-medium">{{ income.source }}</p>
                            <p class="text-xs text-muted-foreground">
                                {% if income.is_received %}
                                    ‚úì Ricevuto {{ income.received_date|date if income.received_date else '' }}
                                {% else %}
                                    ‚óã Previsto
                                {% endif %}
                            </p>
                        </div>
                    </div>
                    <span class="text-xl font-bold text-accent">{{ income.amount|currency }} ‚Ç¨</span>
                </div>
                {% endfor %}
            {% else %}
                <div class="flex items-center justify-between p-3 bg-muted rounded-lg">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">üí∞</span>
                        <div>
                            <p class="font-medium">Entrata prevista</p>
                            <p class="text-xs text-muted-foreground">Basata sulla configurazione</p>
                        </div>
                    </div>
                    <span class="text-xl font-bold text-accent">{{ profile.monthly_income|currency }} ‚Ç¨</span>
                </div>
            {% endif %}
        </div>

        <div class="mt-4 pt-4 border-t border-border flex justify-between items-center">
            <div>
                <p class="text-sm text-muted-foreground">Totale {{ month_name }}</p>
                <p class="text-2xl font-bold">{{ total_income|currency }} ‚Ç¨</p>
            </div>
            <div class="text-right">
                <p class="text-sm text-muted-foreground">Base mensile</p>
                <p class="text-lg font-medium text-muted-foreground">{{ profile.monthly_income|currency }} ‚Ç¨</p>
                {% if total_income > profile.monthly_income %}
                <p class="text-xs text-accent">+{{ (total_income - profile.monthly_income)|currency }} ‚Ç¨ extra questo mese</p>
                {% endif %}
            </div>
        </div>

        <!-- Info box -->
        {% if total_income > profile.monthly_income %}
        <div class="mt-4 p-3 bg-accent/10 border border-accent/20 rounded-lg">
            <p class="text-xs text-accent">
                <span class="font-medium">Nota:</span> Gli introiti extra si applicano solo a {{ month_name }}.
                La proiezione annuale nel Prospetto usa sempre la base mensile di {{ profile.monthly_income|currency }} ‚Ç¨.
            </p>
        </div>
        {% endif %}
    </div>

    <!-- ALLOCAZIONE AUTOMATICA -->
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Allocazione da {{ total_income|currency }} ‚Ç¨</h2>

        <div class="space-y-4">
            <!-- Spese Fisse -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>1Ô∏è‚É£ Spese fisse</span>
                    <span>{{ allocations.fixed|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ ((allocations.fixed / total_income) * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-blue-500" style="width: {{ [((summary.fixed_spent / allocations.fixed) * 100), 100]|min }}%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">Speso: {{ summary.fixed_spent|currency }} ‚Ç¨ ({{ ((summary.fixed_spent / allocations.fixed) * 100)|round|int }}%)</p>
            </div>

            <!-- Spese Variabili -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>2Ô∏è‚É£ Spese variabili</span>
                    <span>{{ allocations.variable|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ ((allocations.variable / total_income) * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-purple-500" style="width: {{ [((summary.variable_spent / allocations.variable) * 100), 100]|min }}%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">Speso: {{ summary.variable_spent|currency }} ‚Ç¨ ({{ ((summary.variable_spent / allocations.variable) * 100)|round|int }}%)</p>
            </div>

            <!-- Accantonamento Tasse -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>3Ô∏è‚É£ Accantonamento tasse</span>
                    <span>{{ allocations.tax|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ (profile.tax_percentage * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-amber-500" style="width: 100%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">‚Üí XEON Tasse</p>
            </div>

            <!-- Investimenti -->
            <div>
                <div class="flex justify-between text-sm mb-1">
                    <span>4Ô∏è‚É£ Investimenti</span>
                    <span>{{ allocations.investment|currency }} ‚Ç¨ <span class="text-muted-foreground">({{ (profile.investment_percentage * 100)|round|int }}%)</span></span>
                </div>
                <div class="progress-bar h-3">
                    <div class="progress-fill bg-accent" style="width: 100%"></div>
                </div>
                <p class="text-xs text-muted-foreground mt-1">‚Üí ETF</p>
            </div>
        </div>

        <!-- Checkbox versamenti -->
        <div class="mt-6 pt-6 border-t border-border">
            <h3 class="text-sm font-medium mb-4">Hai gi√† effettuato questi versamenti per {{ month_name }}?</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 sm:gap-4">
                <form action="/update-monthly-payment" method="POST">
                    <input type="hidden" name="payment_type" value="tax">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <label for="tax_paid" class="flex items-center justify-between p-3 sm:p-4 bg-amber-500/10 border border-amber-500/20 rounded-lg cursor-pointer hover:bg-amber-500/15 transition-colors">
                        <div class="flex items-center gap-3 min-w-0">
                            <input type="checkbox" name="paid" id="tax_paid"
                                   {% if profile.tax_paid_this_month %}checked{% endif %}
                                   onchange="this.form.submit()"
                                   class="w-6 h-6 flex-shrink-0 rounded bg-muted border-amber-500/30 accent-amber-500">
                            <div class="min-w-0">
                                <p class="text-sm font-medium text-amber-400 truncate">Versato {{ allocations.tax|currency }} ‚Ç¨ per tasse</p>
                                <p class="text-xs text-muted-foreground">Sul conto deposito XEON Tasse</p>
                            </div>
                        </div>
                        {% if profile.tax_paid_this_month %}
                        <span class="text-xs text-amber-400 bg-amber-500/20 px-2 py-1 rounded flex-shrink-0 ml-2">Fatto</span>
                        {% endif %}
                    </label>
                </form>

                <form action="/update-monthly-payment" method="POST">
                    <input type="hidden" name="payment_type" value="investment">
                    <input type="hidden" name="year" value="{{ year }}">
                    <input type="hidden" name="month" value="{{ month }}">
                    <label for="invest_paid" class="flex items-center justify-between p-3 sm:p-4 bg-accent/10 border border-accent/20 rounded-lg cursor-pointer hover:bg-accent/15 transition-colors">
                        <div class="flex items-center gap-3 min-w-0">
                            <input type="checkbox" name="paid" id="invest_paid"
                                   {% if profile.investment_paid_this_month %}checked{% endif %}
                                   onchange="this.form.submit()"
                                   class="w-6 h-6 flex-shrink-0 rounded bg-muted border-accent/30 accent-accent">
                            <div class="min-w-0">
                                <p class="text-sm font-medium text-accent truncate">Investito {{ allocations.investment|currency }} ‚Ç¨ in ETF</p>
                                <p class="text-xs text-muted-foreground">PAC su VWCE, SWDA o simili</p>
                            </div>
                        </div>
                        {% if profile.investment_paid_this_month %}
                        <span class="text-xs text-accent bg-accent/20 px-2 py-1 rounded flex-shrink-0 ml-2">Fatto</span>
                        {% endif %}
                    </label>
                </form>
            </div>
        </div>
    </div>

    <!-- 4 PILASTRI -->
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Saldi 4 Pilastri</h2>

        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Conto Corrente -->
            <div class="p-4 bg-muted rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <span>üè¶</span>
                    <span class="text-sm font-medium">Conto Corrente</span>
                </div>
                <p class="text-xl font-bold">{{ profile.current_balance|currency }} ‚Ç¨</p>
                <p class="text-xs text-muted-foreground">Spese quotidiane</p>
            </div>

            {% for pillar in pillars %}
            <div class="p-4 bg-muted rounded-lg">
                <div class="flex items-center gap-2 mb-2">
                    <span>{% if pillar.name == 'emergenza' %}üõ°Ô∏è{% elif pillar.name == 'tasse' %}üìã{% else %}üìà{% endif %}</span>
                    <span class="text-sm font-medium">{{ pillar.display_name|replace(' (2)', '')|replace(' (3)', '')|replace(' (4)', '') }}</span>
                </div>
                <p class="text-xl font-bold {% if pillar.name == 'emergenza' and pillar.actual >= pillar.target %}text-accent{% endif %}">
                    {{ pillar.actual|currency }} ‚Ç¨
                </p>
                {% if pillar.name == 'emergenza' %}
                    {% if pillar.actual >= pillar.target %}
                    <p class="text-xs text-accent">‚úì Target raggiunto</p>
                    {% else %}
                    <p class="text-xs text-muted-foreground">Target: {{ pillar.target|currency }} ‚Ç¨</p>
                    {% endif %}
                {% elif pillar.name == 'tasse' %}
                    <p class="text-xs text-muted-foreground">+{{ (profile.monthly_income * profile.tax_percentage)|currency }} ‚Ç¨/mese</p>
                {% else %}
                    <p class="text-xs text-muted-foreground">+{{ (profile.monthly_income * profile.investment_percentage)|currency }} ‚Ç¨/mese</p>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- SCADENZE FISCALI -->
    {% if deadlines %}
    <div class="card p-6">
        <h2 class="text-xl font-semibold mb-4">Prossime Scadenze Fiscali</h2>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for deadline in deadlines %}
            <div class="p-4 bg-muted rounded-lg {% if deadline.urgent %}border-2 border-red-500{% endif %}">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="font-medium">{{ deadline.name }}</p>
                        <p class="text-sm text-muted-foreground">{{ deadline.due_date|date }}</p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-lg">{{ deadline.residuo|currency }} ‚Ç¨</p>
                        <p class="text-sm {% if deadline.urgent %}text-red-500{% else %}text-muted-foreground{% endif %}">
                            {% if deadline.urgent %}‚ö†Ô∏è {% endif %}{{ deadline.days_remaining }} giorni
                        </p>
                    </div>
                </div>
                {% set tax_pillar = pillars|selectattr('name', 'equalto', 'tasse')|first %}
                {% if tax_pillar %}
                <div class="mt-3 pt-3 border-t border-border">
                    <div class="flex justify-between text-sm">
                        <span class="text-muted-foreground">Copertura XEON Tasse:</span>
                        <span class="{% if tax_pillar.actual >= deadline.residuo %}text-accent{% else %}text-amber-400{% endif %}">
                            {{ ((tax_pillar.actual / deadline.residuo) * 100)|round|int }}%
                        </span>
                    </div>
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Add Income Modal -->
<div id="income-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="card p-4 sm:p-6 w-full max-w-md">
        <div class="flex justify-between items-center mb-4 sm:mb-6">
            <h2 class="text-lg sm:text-xl font-display font-semibold">Aggiungi Entrata</h2>
            <button onclick="document.getElementById('income-modal').classList.add('hidden')"
                    class="p-2 -mr-2 text-muted-foreground hover:text-foreground text-2xl transition-colors" aria-label="Chiudi">&times;</button>
        </div>

        <form action="/income/add" method="POST" class="space-y-4">
            <div>
                <label class="block text-sm font-medium mb-2">Fonte</label>
                <input type="text" name="source" required
                       class="input w-full px-3 sm:px-4 py-3"
                       placeholder="Es: Ufficio Furore, Cliente X">
            </div>

            <div>
                <label class="block text-sm font-medium mb-2">Importo</label>
                <input type="number" name="amount" step="0.01" required
                       class="input w-full px-3 sm:px-4 py-3"
                       placeholder="3500">
            </div>

            <label for="is_received" class="flex items-center gap-3 p-3 -mx-3 rounded-lg hover:bg-white/5 cursor-pointer transition-colors">
                <input type="checkbox" name="is_received" id="is_received" value="true"
                       class="w-6 h-6 rounded bg-muted border-border accent-accent">
                <span class="text-sm">Gi√† ricevuto</span>
            </label>

            <div class="flex gap-3 justify-end pt-4">
                <button type="button"
                        onclick="document.getElementById('income-modal').classList.add('hidden')"
                        class="btn-secondary px-4 sm:px-5 py-2.5 sm:py-3">
                    Annulla
                </button>
                <button type="submit"
                        class="btn-primary px-4 sm:px-5 py-2.5 sm:py-3">
                    Aggiungi
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
