# Handoff - Contaspiccioli

**Data**: 2026-01-13 (aggiornato post-review)
**Progetto**: Contaspiccioli (Cash flow planner 4 pilastri)
**Branch**: `refactor/v2-pillar-cashflow`
**Commit HEAD**: `79683fd`

---

## Stato Attuale

### Refactoring v2: COMPLETO

| Componente | Stato | Note |
|------------|-------|------|
| Phase 0-4 | **Completate** | Schema, services, API, frontend |
| Test | **116 passano** | 4 file test v2 |
| Dashboard v2 | **Funzionante** | `/v2` e `/v2/cashflow` |
| Import CSV | **Implementato** | Auto-categorizzazione |

### Sistema Dual Attivo

Il progetto ha **due sistemi paralleli**:

| Route | Sistema | Backend |
|-------|---------|---------|
| `/`, `/summary`, `/pillars` | v1 (legacy) | models.py, budget.py |
| `/v2`, `/v2/cashflow` | v2 (nuovo) | models_v2.py, *_v2.py |

---

## Review Completa (2026-01-13)

### Bug Hunting: 10 bug identificati

#### Critical (3)

| # | Bug | File | Fix |
|---|-----|------|-----|
| 1 | **Calcolo IRPEF errato** - usa imponibile lordo invece di (imponibile - INPS) | budget.py:136-141 | `irpef = (taxable_income - inps) * tax_rate` |
| 2 | **Catch vuoti** - errori silenziati nel parsing | bank_parser.py:53,166,199 | Loggare eccezioni |
| 3 | **Potenziale None** - category_id non validato | api_v2.py:384-386 | Check esistenza prima del return |

#### Warning (5)

| # | Bug | File |
|---|-----|------|
| 4 | IndexError su CSV vuoto | bank_import_v2.py:154 |
| 5 | Calcolo 3 mesi fragile | pillars_v2.py:196-200 |
| 6 | `_months_elapsed()` ignora anno | budget.py:93-96 |
| 7 | Race condition import duplicati | bank_import_v2.py:361-376 |
| 8 | KeyError potenziale cashflow | api_v2.py:972 |

#### Suggestion (2)

| # | Bug | File |
|---|-----|------|
| 9 | Hardcoded 3500.00 in 5+ posti | multipli |
| 10 | Manca validazione amount negativo | taxes_v2.py:318-333 |

---

### Architecture Review

| Priorita | Issue | Descrizione |
|----------|-------|-------------|
| **P0** | Rimuovere v1 | Duplicazione sistemi paralleli |
| **P1** | Refactor main.py | God object 700+ righe |
| **P1** | Centralizzare default | Valori hardcoded sparsi |
| **P2** | Fix `_months_elapsed()` | Bug documentato |
| **P2** | Estrarre logica cashflow | 230 righe in endpoint API |

---

### Performance Issues

| Priorita | Issue | Impatto |
|----------|-------|---------|
| **CRITICO** | Query N+1 cashflow spreadsheet | ~240 query/request |
| **ALTO** | Calcoli ripetuti senza caching | CPU waste ogni request |
| **ALTO** | Query ridondanti dashboard v2 | Multiple full table scans |
| **MEDIO** | Mancano indici compositi | Slow lookups |

**Fix prioritario**: Query N+1 in `api_v2.py:862-895` - precarica ForecastLine con singola query.

---

### Structural Completeness

**Stato**: Sistema dual **funzionante ma ridondante**

**Decision needed**: Quale piano di sunset per v1?

| Opzione | Descrizione | Effort |
|---------|-------------|--------|
| A | Coesistenza permanente | Basso (freeze v1) |
| B | Migrazione graduale | Medio (script migrazione dati) |
| C | Hard cutover | Alto (rimuovi v1, redirect root) |

---

## Next Steps Consigliati

### Immediato (P0)

1. **Fix Query N+1** - Single query bulk per ForecastLine
2. **Fix Critical Bug #1** - Calcolo IRPEF in budget.py
3. **Decisione v1 sunset** - Scegli opzione A/B/C

### Short-term (P1)

4. **Refactor main.py** - Estrai route in routers/pages.py
5. **Centralizza default** - 3500.00 in config.py
6. **Aggiungi indici compositi** - ForecastLine, Transaction

### Medium-term (P2)

7. **Estrarre logica cashflow** - Da api_v2.py a service dedicato
8. **Caching calculate_monthly_budget** - TTL 5 minuti
9. **Fix warning bugs** - CSV vuoto, race condition, etc.

---

## Comandi Utili

```bash
cd C:\Users\feder\Documents\ClaudeCode\contaspiccioli

# Avvio
docker compose up -d --build
docker compose logs -f contaspiccioli

# Test
docker compose exec contaspiccioli pytest tests/ -v

# Endpoints
curl http://localhost:8001/health
curl http://localhost:8001/v2/cashflow  # Dashboard v2
```

---

## File Chiave

**V2 (attivo)**:
- `app/models_v2.py` - Schema DB v2
- `app/routers/api_v2.py` - REST API (1076 righe)
- `app/services/*_v2.py` - Business logic
- `templates/cashflow_v2.html` - Dashboard principale

**V1 (legacy)**:
- `app/models.py` - Schema DB legacy
- `app/services/budget.py` - Calcoli (con bug IRPEF)
- `app/routers/api.py` - API legacy

**Review da leggere**:
- `IMPLEMENTATION_PLAN.md` - Piano originale + stato aggiornato
